AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Serverless API for Kashish Ecommerce platform

# Configure global properties for resources.
Globals:
  # Globals for AWS::Serverless::Function types
  Function:
    Timeout: 30
    MemorySize: 1024
    
  # Globals for AWS::Serverless::HttpApi types
  HttpApi: 
    Auth:
      EnableIamAuthorizer: true
      DefaultAuthorizer: AWS_IAM

# This represents the parts of our app. i.e. the lambda function and database tables.
Resources:
  
  # Lambda config
  ShopApi:
    Type: AWS::Serverless::Function
    Properties:
      Description: API To manage Kashish Shop actions
      CodeUri: ./src/ShopRepository/
      Handler: ShopRepository
      Runtime: dotnet8

      Policies: # App permissions. Specifically giving our function permission to create,request,update,&delete items in the following DB tables
        - DynamoDBCrudPolicy:
            TableName: !Ref customerTable
        - DynamoDBCrudPolicy:
            TableName: !Ref orderTable
        - DynamoDBCrudPolicy:
            TableName: !Ref stockTable
        - DynamoDBCrudPolicy:
            TableName: !Ref stockRequestsTable

      Environment:
        Variables:
          ORDER_TABLE: !Ref orderTable
          CUSTOMER_TABLE: !Ref customerTable
          STOCK_TABLE: !Ref stockTable
          STOCK_REQUEST_TABLE: !Ref stockRequestsTable
          
          # TODO replace these with AWS secrets manager
          STRIPE_API_KEY: sk_test_51P8grSEvcprk3hy6Npdx7cFlHVlY0fcPofWOTBBJVCj1ZUgmIU4p3paiOaUGyKUwqNoXOb95lJf6yJ8i0v86WQC700pFzxXcsZ
          SECRET_COOKIE_KEY: yadayadayadathisisanicelongsecretkeythatwillbereplacedbeforeprod
          
          LOCAL_DB: http://host.docker.internal:8000

      Events: # Events are what calls the function. In this case we generate an AWS HttpApi gateway. 
        RootApiGateway:
          Type: HttpApi
          Properties:
            Path: /{path+} # What endpoints this API is mapped too. {path+} maps all endpoints in our application.
            Method: ANY
            Auth:
              Authorizer: AWS_IAM

  # Database config.
  customerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: "Customers"
      
      # At least for testing we shouldn't provision excess capacity
      BillingMode: "PAY_PER_REQUEST"
      
      # All attributes that will be used for keying
      AttributeDefinitions:
        - AttributeName: "Id"
          AttributeType: "S"
        - AttributeName: "Email"
          AttributeType: "S"
        - AttributeName: "StripeId"
          AttributeType: "S"
      
      # Primary Key Definition: 
      KeySchema:
        - AttributeName: "Id"
          KeyType: "HASH"
      
      # Indexes so we can key on other items (lets us query instead of scanning on these attributes)
      GlobalSecondaryIndexes:
        - IndexName: "CustomerEmailIndex"
          KeySchema:
            - AttributeName: "Email"
              KeyType: "HASH"
          Projection:
            ProjectionType: "KEYS_ONLY"
            
        - IndexName: "CustomerStripeIndex"
          KeySchema:
            - AttributeName: "StripeId"
              KeyType: "HASH"
          Projection: 
            ProjectionType: "KEYS_ONLY"
               
  
  orderTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: "Orders"
      
      BillingMode: "PAY_PER_REQUEST"
      
      AttributeDefinitions:
        - AttributeName: "Id"
          AttributeType: "S"
        - AttributeName: "CustomerId"
          AttributeType: "S"
        - AttributeName: "PaymentIntentId"
          AttributeType: "S"
          
      KeySchema:
        - AttributeName: "Id"
          KeyType: "HASH"

      GlobalSecondaryIndexes:
        - IndexName: "OrderCustomerIndex"
          KeySchema:
            - AttributeName: "CustomerId"
              KeyType: "HASH"
          Projection:
            ProjectionType: "KEYS_ONLY"
    
        - IndexName: "OrderPaymentIndex"
          KeySchema:
            - AttributeName: "PaymentIntentId"
              KeyType: "HASH"
          Projection:
            ProjectionType: "KEYS_ONLY"        

  stockTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: "Stock"
      
      BillingMode: "PAY_PER_REQUEST"
      
      AttributeDefinitions:
        - AttributeName: "Id"
          AttributeType: "S"
        - AttributeName: "StripeId"
          AttributeType: "S"
          
      KeySchema:
        - AttributeName: "Id"
          KeyType: "HASH"

      GlobalSecondaryIndexes:
        - IndexName: "StockStripeIndex"
          KeySchema:
            - AttributeName: "StripeId"
              KeyType: "HASH"
          Projection:
            ProjectionType: "KEYS_ONLY"
  
  stockRequestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: "StockRequests"
      
      BillingMode: "PAY_PER_REQUEST"
      
      AttributeDefinitions:
        - AttributeName: "Id"
          AttributeType: "S"
          
      KeySchema:
        - AttributeName: "Id"
          KeyType: "HASH"

# Information to output into the AWS stack in cloudformation. In this case we output the endpoint of our shop api for easy access.
Outputs:
  ShopApiEndpoint:
    Description: "Shop API Gateway Endpoint URL"
    Value: !Sub "https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com/"
